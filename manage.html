<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Booking - Obour Airline</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<header>
  <div class="header-content">
    <h1>Obour Airline</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="booking.html">Book a Flight</a>
      <a href="manage.html">My Trips</a>
      <span id="authNav">
        <a href="login.html">Login</a>
      </span>
    </nav>
  </div>
</header>

<main>
  <section class="card">
    <h2>Manage Your Booking</h2>
    <form id="retrieveForm">
      <div class="form-row">
        <div class="form-group">
          <label>Booking Reference</label>
          <input type="text" name="booking_ref" placeholder="OBA123ABC" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="email" id="emailInput" placeholder="your@email.com" required>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Retrieve Booking</button>
    </form>
    
    <div id="bookingDetails"></div>
  </section>
</main>

<script>
let currentBooking = null;
let loggedInUser = null;

// Check login status
fetch('check_session.php')
.then(response => response.json())
.then(data => {
    const authNav = document.getElementById('authNav');
    if(data.logged_in) {
        loggedInUser = data.user;
        authNav.innerHTML = '<span style="color: white; margin-right: 10px;">Welcome, ' + data.user.first_name + '!</span> <a href="#" onclick="logout(); return false;">Logout</a>';
        
        // Pre-fill email
        document.getElementById('emailInput').value = data.user.email;
    }
})
.catch(error => console.error('Error checking session:', error));

function logout() {
    fetch('logout.php')
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            localStorage.removeItem('user');
            alert('Logged out successfully!');
            window.location.href = 'login.html';
        }
    })
    .catch(error => console.error('Error:', error));
}

document.getElementById('retrieveForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const bookingRef = formData.get('booking_ref');
    const email = formData.get('email');
    const detailsDiv = document.getElementById('bookingDetails');
    
    detailsDiv.innerHTML = '<p>Searching for your booking...</p>';
    
    fetch('get_booking.php?booking_ref=' + bookingRef + '&email=' + email)
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            currentBooking = data.booking;
            displayBooking(data.booking);
        } else {
            detailsDiv.innerHTML = '<div class="card" style="background: #ffe0e0;"><p style="color: red;">' + data.message + '</p></div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        detailsDiv.innerHTML = '<div class="card" style="background: #ffe0e0;"><p style="color: red;">Error retrieving booking. Make sure XAMPP is running!</p></div>';
    });
});

function displayBooking(booking) {
    const detailsDiv = document.getElementById('bookingDetails');
    
    const statusColor = booking.status === 'confirmed' ? '#28a745' : '#dc3545';
    const statusText = booking.status.toUpperCase();
    
    let html = '<div class="card" style="border-left: 4px solid ' + statusColor + ';">';
    html += '<h3>Booking Details</h3>';
    html += '<p><strong>Booking Reference:</strong> ' + booking.booking_ref + '</p>';
    html += '<p><strong>Status:</strong> <span style="color: ' + statusColor + '; font-weight: bold;">' + statusText + '</span></p>';
    html += '<p><strong>Booking Date:</strong> ' + new Date(booking.booking_date).toLocaleString() + '</p>';
    html += '<hr style="margin: 20px 0;">';
    html += '<h4>Flight Information</h4>';
    html += '<p><strong>' + booking.airline_name + ' - Flight ' + booking.flight_number + '</strong></p>';
    html += '<p><strong>Route:</strong> ' + booking.departure_city + ' to ' + booking.arrival_city + '</p>';
    html += '<p><strong>Date:</strong> ' + booking.departure_date + '</p>';
    html += '<p><strong>Departure:</strong> ' + booking.departure_time + ' | <strong>Arrival:</strong> ' + booking.arrival_time + '</p>';
    html += '<hr style="margin: 20px 0;">';
    html += '<h4>Passenger Information</h4>';
    html += '<p><strong>Name:</strong> ' + booking.passenger_first + ' ' + booking.passenger_last + '</p>';
    if(booking.passport_number) {
        html += '<p><strong>Passport:</strong> ' + booking.passport_number + '</p>';
    }
    html += '<hr style="margin: 20px 0;">';
    
    // Luggage Section
    html += '<h4>Luggage</h4>';
    if(booking.luggage && booking.luggage.length > 0) {
        html += '<div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">';
        booking.luggage.forEach(luggage => {
            html += '<p>' + luggage.luggage_type + ' - $' + parseFloat(luggage.price).toFixed(2) + '</p>';
        });
        html += '</div>';
    } else {
        html += '<p>No luggage added yet</p>';
    }
    
    if(booking.status === 'confirmed') {
        html += '<button onclick="showAddLuggage()" class="btn btn-primary" style="margin-top: 10px;">Add Luggage</button>';
    }
    
    html += '<div id="luggageForm" style="display: none; margin-top: 15px; background: #e3f2fd; padding: 15px; border-radius: 8px;"></div>';
    
    html += '<hr style="margin: 20px 0;">';
    html += '<h4>Payment Information</h4>';
    html += '<p><strong>Total Amount:</strong> <span id="totalAmount">$' + parseFloat(booking.total_amount).toFixed(2) + '</span></p>';
    html += '<p><strong>Payment Method:</strong> ' + booking.payment_method + '</p>';
    html += '<p><strong>Payment Status:</strong> ' + booking.payment_status + '</p>';
    
    if(booking.status === 'confirmed') {
        html += '<hr style="margin: 20px 0;">';
        html += '<button onclick="cancelBooking(\'' + booking.booking_ref + '\')" class="btn btn-secondary">Cancel Booking</button>';
    }
    
    html += '</div>';
    
    detailsDiv.innerHTML = html;
}

function showAddLuggage() {
    const luggageFormDiv = document.getElementById('luggageForm');
    
    fetch('get_luggage_prices.php')
    .then(response => response.json())
    .then(prices => {
        let html = '<h4>Add Luggage</h4>';
        html += '<form id="addLuggageForm">';
        html += '<div class="form-group"><label>Select Luggage Type</label><select name="luggage_type" id="luggageSelect" required>';
        
        prices.forEach(price => {
            html += '<option value="' + price.luggage_type + '" data-weight="' + price.max_weight + '" data-price="' + price.price + '">';
            html += price.luggage_type + ' - $' + parseFloat(price.price).toFixed(2);
            html += '</option>';
        });
        
        html += '</select></div>';
        html += '<input type="hidden" name="weight" id="luggageWeight">';
        html += '<input type="hidden" name="price" id="luggagePrice">';
        html += '<button type="submit" class="btn btn-primary">Add to Booking</button>';
        html += '<button type="button" onclick="hideAddLuggage()" class="btn btn-secondary" style="margin-left: 10px;">Cancel</button>';
        html += '</form>';
        
        luggageFormDiv.innerHTML = html;
        luggageFormDiv.style.display = 'block';
        
        document.getElementById('luggageSelect').addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            document.getElementById('luggageWeight').value = selected.getAttribute('data-weight');
            document.getElementById('luggagePrice').value = selected.getAttribute('data-price');
        });
        
        document.getElementById('luggageSelect').dispatchEvent(new Event('change'));
        
        document.getElementById('addLuggageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addLuggage();
        });
    })
    .catch(error => console.error('Error loading luggage prices:', error));
}

function hideAddLuggage() {
    document.getElementById('luggageForm').style.display = 'none';
}

function addLuggage() {
    const formData = new FormData(document.getElementById('addLuggageForm'));
    formData.append('booking_id', currentBooking.booking_id);
    
    fetch('add_luggage.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            alert('Luggage added successfully!');
            hideAddLuggage();
            document.getElementById('retrieveForm').dispatchEvent(new Event('submit'));
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding luggage');
    });
}

function cancelBooking(bookingRef) {
    if(!confirm('Are you sure you want to cancel this booking?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('booking_ref', bookingRef);
    formData.append('email', document.querySelector('input[name="email"]').value);
    
    fetch('cancel_booking.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            alert('Booking cancelled successfully!');
            document.getElementById('retrieveForm').dispatchEvent(new Event('submit'));
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error cancelling booking');
    });
}
</script>

</body>
</html>
